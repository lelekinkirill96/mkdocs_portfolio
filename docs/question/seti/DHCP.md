

DHCP работает на прикладном (Application) уровне модели TCP/IP и модели OSI, так как он предоставляет услуги, такие как назначение IP-адресов и других сетевых параметров, для клиентских устройств, подключающихся к сети.

### Процесс работы DHCP состоит из нескольких этапов:

1. **DISCOVER (Обнаружение)**: Когда компьютер или другое устройство, поддерживающее DHCP, подключается к сети, оно отправляет широковещательный запрос по всей физической сети с целью обнаружить доступные DHCP-серверы. Запрос от клиента идет по протоколу UDP с порта 67 на порт 68, в качестве адреса источника указывается адрес 0.0.0.0 (если клиент еще не получал адрес), а в качестве адреса назначения используется широковещательный адрес 255.255.255.255. В запросе содержится следующая информация - уникальный номер транзакции, аппаратный (MAC) адрес сетевой карты и последний выданный клиенту IP адрес (его может и не быть).
2. **OFFER (Предложение)**: Получив запрос, сервер определяет требуемую конфигурацию клиента и передает ее на MAC. В ответе содержится следующая информация - назначенный IP-адрес, маска подсети, адрес шлюза и другая необходимая информация.
3. **REQUEST (Запрос)**: Получив конфигурацию от сервера DHCP, устройство отправляет широковещательный запрос REQUEST. Если конфигурация клиентом уже была получена ранее и требуется продление аренды, то запрос отправляется адресно. При этом, если сервер не ответил вовремя, то запрос направляется широковещательно.
4. **ACK (Подтверждение)**: Сервер подтверждает запрос и направляет подтверждение клиенту. После этого клиент применяет полученные настройки. 

Эту процедуру часто называют **DORA** (Discover, Offer, Request, Ack) и обычно изображают так:

<img src="../images/работа%20DHCP.png" alt="Описание" style="width: 800px; height: 800px;"/>

### Основные механизмы распределения IP-адресов DHCP-сервером.

Используется всего три способа распределения адресов для обеспечения вариативности при назначении IP-адресов:

- Ручное распределение - при этом способе администратор сопоставляет MAC-адреса с выдаваемыми IP-адресами каждому компьютеру. Фактически данный способ отличается от ручной настройки лишь тем, что информация об адресах хранится централизованно на DHCP-сервере.

- Автоматическое распределение - При данном способе каждому компьютеру выделяется на постоянной основе свободный IP-адрес из пула доступных адресов.

- Динамическое распределение - этот способ аналогичен автоматическому распределению, разница лишь в том, что адреса выдаются на определенный срок(аренда). По истечении срока аренды IP-адрес считается свободным, и компьютер обязан запросить новый.

### Параметры DHCP

Параметры, отправленные в пакете DHCP Discover, - это список сетевых настроек DHCP, с которыми клиент знает, что делать. Пакет сервера Offer пытается заполнить как можно большую часть этого списка. Вот параметры, которые особенно часто запрашиваются:
- Маска подсети;
- Роутер (шлюз по умолчанию);
- Список серверов DNS;
- Доменное имя DNS

### Запросы DHCP из других подсетей

Во многих корпоративных сетях серверы находятся в своей собственной подсети; разделять серверы и рабочие станции — довольно
распространенная практика. Как этот механизм DHCP работает в таком случае? Первые три пакета последовательности DORA отправляются на широко­вещательный адрес, поэтому они могут достигать других узлов только в той же VLAN.

Эту проблему можно решить, если разместить процесс перенаправления (forwarder) или ретрансляции (relay) DHCP на узле в клиентской подсети. Этот процесс принимает локальные широковещательные рассылки, а затем пересылает их на сервер
DHCP в одноадресном режиме. Когда сервер DHCP отправляет ответ (как одно-адресное сообщение перенаправляющему узлу), перенаправляющий сервер преобразует этот пакет обратно в широковещательный ответ, которого ожидает клиент.
Почти всегда это перенаправление выполняется на IP-адресе маршрутизатора или коммутатора, который находится в клиентской подсети, другими словами, на интерфейсе, который в конечном итоге станет шлюзом клиента по умолчанию.
Формально эта функциональность не обязана быть именно на этом интерфейсе, но размещать ее там удобно: как правило, это интерфейс, в доступности которого мы уверены, так что перенаправление тоже будет доступно практически всегда.
Кроме того, если принять это за неписаное правило, то нужную команду будет проще найти, если впоследствии ее понадобится изменить. На маршрутизатореили коммутаторе Cisco эта команда выглядит так:

```
interface VLAN <x> 
    ip helper-address 10.10.10.10
```
Здесь 10.10.10.10 — это IP-адрес нашего DHCP-сервера.

На практике при этом к простой широковещательной операции, которая используется в большинстве домашних сетей, добавляется одноадресная ветвь, которая расширяет протокол до сервера DHCP, расположенного в другой подсети:

<img src="./images/Перенаправление%20DHCP.png" alt="Описание" style="width: 800px; height: 800px;"/>